<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Management - MCBP V2</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Socket.IO Client Library -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bots-page">
    <!-- Top Navigation Bar -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="logo">
                <i class=></i> MCBP V2
            </div>
            <div class="version">Cupchuck</div>
        </div>
        
        <div class="topbar-right">
            <div class="user-info">
                <i class=""></i>
                <span id="current-username">Loading...</span>
            </div>
            <button onclick="window.location.href='/dashboard'" class="btn-secondary">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button onclick="logout()" class="btn-secondary">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div class="container">
        <div class="navigation mb-4">
            <button onclick="window.location.href='/dashboard'" class="btn-secondary">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button onclick="window.location.href='/bots'" class="btn">
                <i class="fas fa-server"></i> Bots
            </button>
            <button onclick="window.location.href='/users'" class="btn-secondary">
                <i class="fas fa-users"></i> Users
            </button>
            <button onclick="window.location.href='/roles'" class="btn-secondary">
                <i class="fas fa-user-tag"></i> Roles
            </button>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h3><i class="fas fa-server"></i> Bot Management</h3>
                <button onclick="showAddBotModal()" class="btn" id="add-bot-btn">
                    <i class="fas fa-plus"></i> Add Bot
                </button>
            </div>
            <div class="panel-content">
                <div id="bots-table-container">
                    <table id="bots-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Server</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bots-table-body">
                            <!-- Bots will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-bots-message" class="empty-state">
                    <i class="fas fa-server"></i>
                    <p>No bots configured yet</p>
                    <button onclick="showAddBotModal()" class="btn mt-2">
                        <i class="fas fa-plus"></i> Create First Bot
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Bot Modal -->
    <div id="bot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"><i class="fas fa-plus"></i> Add New Bot</h3>
                <button onclick="closeBotModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bot-name">Bot Name *</label>
                    <input type="text" id="bot-name" placeholder="e.g., Main KeepAlive Bot">
                    <small class="text-muted">Display name for the bot</small>
                </div>
                
                <div class="form-group">
                    <label for="bot-username">Minecraft Username *</label>
                    <input type="text" id="bot-username" placeholder="e.g., KeepAliveBot">
                </div>
                
                <div class="form-group">
                    <label for="bot-password">AuthMe Password *</label>
                    <input type="password" id="bot-password" placeholder="Password for /register and /login">
                </div>
                
                <div class="form-group">
                    <label for="bot-server">Server Address *</label>
                    <input type="text" id="bot-server" placeholder="play.example.com">
                </div>
                
                <div class="form-group">
                    <label for="bot-port">Server Port</label>
                    <input type="number" id="bot-port" value="25565" min="1" max="65535">
                </div>
                
                <div class="form-group">
                    <label for="bot-version">Minecraft Version</label>
                    <input type="text" id="bot-version" value="1.21.1" placeholder="1.21.1">
                </div>
                
                <div class="form-group">
                    <label for="bot-auth">Authentication Type</label>
                    <select id="bot-auth">
                        <option value="offline">Offline (Cracked)</option>
                        <option value="microsoft">Microsoft Account</option>
                        <option value="mojang">Mojang Account</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="checkbox">
                        <input type="checkbox" id="bot-enabled" checked>
                        <span>Enabled (bot will auto-connect on start)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="bot-tags">Tags (comma separated)</label>
                    <input type="text" id="bot-tags" placeholder="primary, monitoring, backup">
                    <small class="text-muted">Used for organization</small>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBotModal()" class="btn-secondary">Cancel</button>
                <button onclick="saveBot()" class="btn" id="save-bot-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Bot Modal -->
    <div id="delete-bot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-trash"></i> Delete Bot</h3>
                <button onclick="closeDeleteBotModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="delete-bot-name"></span>"?</p>
                <p class="text-muted">This will permanently remove the bot configuration. Any running instance will be stopped.</p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDeleteBotModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmDeleteBot()" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script src="../common.js"></script>
    <script>
        let currentUser = null;
        let editingBotId = null;
        let botToDelete = null;
        let socket = null;
        let botStatuses = {};

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUserInfo();
            loadBots();
            setupWebSocket();
        });

        function checkAuth() {
            const token = localStorage.getItem('mcbp-token');
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            fetch('/api/verify', {
                headers: { 'x-auth-token': token }
            })
            .then(response => {
                if (!response.ok) {
                    localStorage.clear();
                    window.location.href = '/';
                }
            })
            .catch(() => {
                localStorage.clear();
                window.location.href = '/';
            });
        }

        function loadUserInfo() {
            const userStr = localStorage.getItem('mcbp-user');
            if (userStr) {
                currentUser = JSON.parse(userStr);
                document.getElementById('current-username').textContent = currentUser.username;
                
                const canCreateBots = currentUser.permissions.includes('create_bots') || 
                                     currentUser.permissions.includes('*');
                document.getElementById('add-bot-btn').style.display = canCreateBots ? '' : 'none';
            }
        }

        function setupWebSocket() {
            const token = localStorage.getItem('mcbp-token');
            if (!token) return;

            if (typeof io === 'undefined') {
                console.error('Socket.IO client library not loaded!');
                return;
            }

            try {
                socket = io({
                    auth: { token },
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log('Bots page WebSocket connected');
                });

                socket.on('bot-status', (status) => {
                    botStatuses[status.botId] = status;
                    updateBotRow(status.botId, status);
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket connection error:', error);
                });

                socket.on('disconnect', (reason) => {
                    console.log('WebSocket disconnected:', reason);
                });

            } catch (error) {
                console.error('Failed to setup WebSocket:', error);
            }
        }

        function loadBots() {
            fetch('/api/bots', {
                headers: { 'x-auth-token': localStorage.getItem('mcbp-token') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    renderBotsTable(data.bots);
                }
            })
            .catch(error => {
                console.error('Failed to load bots:', error);
                showToast('Failed to load bots', 'error');
            });
        }

        function renderBotsTable(bots) {
            const tbody = document.getElementById('bots-table-body');
            const noBots = document.getElementById('no-bots-message');
            
            if (!bots || bots.length === 0) {
                tbody.innerHTML = '';
                noBots.style.display = 'block';
                return;
            }
            
            noBots.style.display = 'none';
            
            tbody.innerHTML = bots.map(bot => {
                const status = botStatuses[bot.id] ? botStatuses[bot.id].status : (bot.status || 'offline');
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                
                return `
                    <tr id="bot-row-${bot.id}">
                        <td>
                            <strong>${bot.name}</strong>
                            ${bot.tags && bot.tags.length > 0 ? `
                                <div class="tags mt-1">
                                    ${bot.tags.map(tag => `<span class="badge badge-secondary">${tag}</span>`).join(' ')}
                                </div>
                            ` : ''}
                        </td>
                        <td>${bot.username}</td>
                        <td>${bot.server}:${bot.port}</td>
                        <td>
                            <span class="status-dot ${statusClass} mr-2"></span>
                            ${statusText}
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${status === 'online' ? `
                                    <button onclick="stopBot('${bot.id}')" class="btn-danger btn-sm">
                                        <i class="fas fa-stop"></i> Stop
                                    </button>
                                ` : `
                                    <button onclick="startBot('${bot.id}')" class="btn-success btn-sm">
                                        <i class="fas fa-play"></i> Start
                                    </button>
                                `}
                                <button onclick="editBot('${bot.id}')" class="btn-secondary btn-sm">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="viewBotDetails('${bot.id}')" class="btn-info btn-sm">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button onclick="deleteBotPrompt('${bot.id}', '${bot.name}')" 
                                        class="btn-danger btn-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'online': 'Online',
                'offline': 'Offline',
                'connecting': 'Connecting',
                'reconnecting': 'Reconnecting'
            };
            return statusMap[status] || 'Offline';
        }

        function getStatusClass(status) {
            if (status === 'reconnecting') return 'connecting';
            if (status === 'error') return 'offline';
            return status || 'offline';
        }

        function updateBotRow(botId, status) {
            const row = document.getElementById(`bot-row-${botId}`);
            if (!row) return;
            
            const statusCell = row.cells[3];
            const actionCell = row.cells[4];
            const statusText = getStatusText(status.status);
            const statusClass = getStatusClass(status.status);
            
            statusCell.innerHTML = `
                <span class="status-dot ${statusClass} mr-2"></span>
                ${statusText}
            `;
            
            let actionButtons = '';
            if (status.status === 'online') {
                actionButtons = `
                    <button onclick="stopBot('${botId}')" class="btn-danger btn-sm">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                `;
            } else {
                actionButtons = `
                    <button onclick="startBot('${botId}')" class="btn-success btn-sm">
                        <i class="fas fa-play"></i> Start
                    </button>
                `;
            }
            
            actionButtons += `
                <button onclick="editBot('${botId}')" class="btn-secondary btn-sm">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button onclick="viewBotDetails('${botId}')" class="btn-info btn-sm">
                    <i class="fas fa-info-circle"></i> Details
                </button>
                <button onclick="deleteBotPrompt('${botId}', '${botId}')" 
                        class="btn-danger btn-sm">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;
            
            actionCell.querySelector('.action-buttons').innerHTML = actionButtons;
        }

        function showAddBotModal() {
            if (!checkPermission('create_bots')) return;
            
            editingBotId = null;
            document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus"></i> Add New Bot';
            document.getElementById('save-bot-btn').textContent = 'Save';
            
            document.getElementById('bot-name').value = '';
            document.getElementById('bot-username').value = '';
            document.getElementById('bot-password').value = '';
            document.getElementById('bot-server').value = '';
            document.getElementById('bot-port').value = '25565';
            document.getElementById('bot-version').value = '1.21.1';
            document.getElementById('bot-auth').value = 'offline';
            document.getElementById('bot-enabled').checked = true;
            document.getElementById('bot-tags').value = '';
            
            document.getElementById('bot-modal').classList.add('active');
            document.getElementById('bot-name').focus();
        }

        function editBot(botId) {
            if (!checkPermission('edit_bots')) return;
            
            fetch(`/api/bots/${botId}`, {
                headers: { 'x-auth-token': localStorage.getItem('mcbp-token') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    editingBotId = botId;
                    const bot = data.bot;
                    
                    document.getElementById('modal-title').innerHTML = '<i class="fas fa-edit"></i> Edit Bot';
                    document.getElementById('save-bot-btn').textContent = 'Update';
                    
                    document.getElementById('bot-name').value = bot.name || '';
                    document.getElementById('bot-username').value = bot.username || '';
                    document.getElementById('bot-password').value = '';
                    document.getElementById('bot-server').value = bot.server || '';
                    document.getElementById('bot-port').value = bot.port || 25565;
                    document.getElementById('bot-version').value = bot.version || '1.21.1';
                    document.getElementById('bot-auth').value = bot.auth || 'offline';
                    document.getElementById('bot-enabled').checked = bot.enabled !== false;
                    document.getElementById('bot-tags').value = bot.tags ? bot.tags.join(', ') : '';
                    
                    document.getElementById('bot-modal').classList.add('active');
                } else {
                    showToast(data.message || 'Failed to load bot', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to load bot:', error);
                showToast('Network error', 'error');
            });
        }

        function closeBotModal() {
            document.getElementById('bot-modal').classList.remove('active');
        }

        function saveBot() {
            const name = document.getElementById('bot-name').value.trim();
            const username = document.getElementById('bot-username').value.trim();
            const password = document.getElementById('bot-password').value;
            const server = document.getElementById('bot-server').value.trim();
            const port = parseInt(document.getElementById('bot-port').value);
            const version = document.getElementById('bot-version').value.trim();
            const auth = document.getElementById('bot-auth').value;
            const enabled = document.getElementById('bot-enabled').checked;
            const tags = document.getElementById('bot-tags').value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!name || !username || !server || !version) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            if (port < 1 || port > 65535) {
                showToast('Port must be between 1 and 65535', 'error');
                return;
            }
            
            const botData = {
                name,
                username,
                server,
                port,
                version,
                auth,
                enabled,
                tags
            };
            
            if (password) {
                botData.password = password;
            }
            
            const method = editingBotId ? 'PUT' : 'POST';
            const url = editingBotId ? `/api/bots/${editingBotId}` : '/api/bots';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': localStorage.getItem('mcbp-token')
                },
                body: JSON.stringify(botData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    closeBotModal();
                    loadBots();
                    showToast(editingBotId ? 'Bot updated successfully' : 'Bot created successfully', 'success');
                } else {
                    showToast(data.message || 'Failed to save bot', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to save bot:', error);
                showToast('Network error', 'error');
            });
        }

        function deleteBotPrompt(botId, botName) {
            if (!checkPermission('delete_bots')) return;
            
            botToDelete = botId;
            document.getElementById('delete-bot-name').textContent = botName;
            document.getElementById('delete-bot-modal').classList.add('active');
        }

        function closeDeleteBotModal() {
            document.getElementById('delete-bot-modal').classList.remove('active');
            botToDelete = null;
        }

        function confirmDeleteBot() {
            if (!botToDelete) return;
            
            fetch(`/api/bots/${botToDelete}`, {
                method: 'DELETE',
                headers: { 'x-auth-token': localStorage.getItem('mcbp-token') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    closeDeleteBotModal();
                    loadBots();
                    showToast('Bot deleted successfully', 'success');
                } else {
                    showToast(data.message || 'Failed to delete bot', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to delete bot:', error);
                showToast('Network error', 'error');
            });
        }

        function startBot(botId) {
            if (!checkPermission('start_bots')) return;
            
            fetch(`/api/bots/${botId}/start`, {
                method: 'POST',
                headers: { 'x-auth-token': localStorage.getItem('mcbp-token') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showToast('Bot started', 'success');
                } else {
                    showToast(data.message || 'Failed to start bot', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to start bot:', error);
                showToast('Network error', 'error');
            });
        }

        function stopBot(botId) {
            if (!checkPermission('stop_bots')) return;
            
            fetch(`/api/bots/${botId}/stop`, {
                method: 'POST',
                headers: { 'x-auth-token': localStorage.getItem('mcbp-token') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showToast('Bot stopped', 'success');
                } else {
                    showToast(data.message || 'Failed to stop bot', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to stop bot:', error);
                showToast('Network error', 'error');
            });
        }

        function viewBotDetails(botId) {
            window.location.href = `/bot-details?bot=${botId}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                      type === 'error' ? 'exclamation-circle' : 
                                      type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
    </script>
</body>
</html>